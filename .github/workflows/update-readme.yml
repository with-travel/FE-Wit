name: ğŸ“– README ìë™ ì—…ë°ì´íŠ¸

# ios-testflight ì›Œí¬í”Œë¡œìš°ê°€ ëë‚˜ë©´ ì‹¤í–‰
on:
  workflow_run:
    workflows: ["ğŸ“¦ iOS Build & ğŸš€ TestFlight"]
    types:
      - completed
  workflow_dispatch:

jobs:
  update-readme:
    # ios-testflightê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    permissions:
      contents: write # ì»¤ë°‹/í‘¸ì‹œ ê¶Œí•œ

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.js ì„¸íŒ…
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: CHANGELOG.jsonì—ì„œ ìµœì‹  ë¦´ë¦¬ì¦ˆ ì •ë³´ ì½ê¸°
        id: read_changelog
        run: |
          # CHANGELOG.json íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "CHANGELOG.json" ]; then
            echo "âŒ CHANGELOG.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          # jq ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ jq ì„¤ì¹˜ ì¤‘..."
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # ìµœì‹  ë¦´ë¦¬ì¦ˆ ì •ë³´ ì¶”ì¶œ
          LATEST=$(jq '.releases[0]' CHANGELOG.json)

          if [ "$LATEST" = "null" ] || [ -z "$LATEST" ]; then
            echo "âŒ CHANGELOG.jsonì—ì„œ ë¦´ë¦¬ì¦ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          VERSION=$(echo "$LATEST" | jq -r '.version')
          DATE=$(echo "$LATEST" | jq -r '.date')

          echo "ğŸ“‹ ë²„ì „: $VERSION"
          echo "ğŸ“… ë‚ ì§œ: $DATE"

          # parsed_changesë¥¼ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •)
          CHANGES=$(echo "$LATEST" | jq -r '
            .parsed_changes | to_entries[] | 
            "**" + (.key | gsub("_"; " ") | ascii_upcase) + "**\n" +
            (.value[] | "- " + . + "\n")
          ')

          # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "âœ… CHANGELOG ì •ë³´ ì¶”ì¶œ ì™„ë£Œ"

      - name: README.md ìƒì„±/ê°±ì‹ 
        run: |
          VERSION="${{ steps.read_changelog.outputs.version }}"
          DATE="${{ steps.read_changelog.outputs.date }}"
          CHANGES="${{ steps.read_changelog.outputs.changes }}"

          echo "# Wit App" > README.md
          echo "" >> README.md
          echo "ê°„ë‹¨í•œ ì•± ì†Œê°œ ë¬¸êµ¬ë¥¼ ì—¬ê¸°ì— ì ìŠµë‹ˆë‹¤." >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          echo "## ìµœì‹  ë²„ì „ ì •ë³´" >> README.md
          echo "" >> README.md
          echo "**ë²„ì „:** $VERSION" >> README.md
          echo "**ë³€ê²½ ë‚ ì§œ:** $DATE" >> README.md
          echo "" >> README.md
          echo "### ë³€ê²½ ì‚¬í•­" >> README.md
          echo "" >> README.md
          echo "$CHANGES" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          echo "[ì´ì „ ë³€ê²½ì‚¬í•­ ë³´ê¸°](PREVIOUS_CHANGES.md)" >> README.md

      - name: ì´ì „ ë³€ê²½ì‚¬í•­ ì „ì²´ ë¬¸ì„œ ìƒì„±
        run: |
          # CHANGELOG.md íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if [ -f "CHANGELOG.md" ]; then
            cp CHANGELOG.md PREVIOUS_CHANGES.md
            echo "âœ… PREVIOUS_CHANGES.md ìƒì„± ì™„ë£Œ"
          else
            echo "âš ï¸ CHANGELOG.md íŒŒì¼ì´ ì—†ì–´ PREVIOUS_CHANGES.mdë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            touch PREVIOUS_CHANGES.md
          fi

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° main ë¸Œëœì¹˜ í‘¸ì‹œ
        run: |
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ìµœì‹  ìƒíƒœë¡œ pull
          git pull origin main

          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add README.md PREVIOUS_CHANGES.md

          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --cached --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 0
          else
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            VERSION="${{ steps.read_changelog.outputs.version }}"
            COMMIT_MSG="docs: README ìµœì‹  ë¦´ë¦¬ì¦ˆ(v${VERSION}) ìë™ ì—…ë°ì´íŠ¸"
            
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:main
            
            echo "âœ… main ë¸Œëœì¹˜ì— ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ"
          fi

      - name: develop ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ë° main ë³€ê²½ì‚¬í•­ rebase
        run: |
          git fetch origin
          git checkout develop
          git pull origin develop
          set -e
          if git rebase main; then
            echo "âœ… develop ë¸Œëœì¹˜ì— main ë³€ê²½ì‚¬í•­ rebase ì„±ê³µ"
            git push origin develop
          else
            echo "âŒ rebase ì¤‘ ì¶©ëŒ ë°œìƒ! ìˆ˜ë™ í•´ê²° í•„ìš”"
            git rebase --abort
            exit 1
          fi

      - name: ì—…ë°ì´íŠ¸ ì™„ë£Œ ì•Œë¦¼
        run: |
          VERSION="${{ steps.read_changelog.outputs.version }}"
          DATE="${{ steps.read_changelog.outputs.date }}"

          echo "âœ… README ìë™ ì—…ë°ì´íŠ¸ ë° develop ë¸Œëœì¹˜ ë°˜ì˜ ì™„ë£Œ!"
          echo "ğŸ“¦ ë²„ì „: $VERSION"
          echo "ğŸ“… ë‚ ì§œ: $DATE"
          echo "ğŸ“„ README.md ë° PREVIOUS_CHANGES.mdê°€ main, develop ëª¨ë‘ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤"
