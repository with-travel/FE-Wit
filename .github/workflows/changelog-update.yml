name: CHANGELOG ìë™ ì—…ë°ì´íŠ¸

on:
  pull_request:
    types: [opened, synchronize]
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-changelog:
    name: CHANGELOG.json ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: develop

      - name: Git ì„¤ì • ë° ìµœì‹  ìƒíƒœ ë™ê¸°í™”
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull origin develop

          - name: í˜„ì¬ ë²„ì „ í™•ì¸
          id: current_version
          run: |
            CURRENT_VERSION=$(grep '"version":' app.json | sed 's/.*"version": "\([^"]*\)".*/\1/')
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"

      - name: ìƒˆ ë²„ì „ ê³„ì‚° (patch ë²„ì „ ì¦ê°€)
        id: version
        run: |
          VERSION="${{ steps.current_version.outputs.current_version }}"

          # patch ë²„ì „ ì¦ê°€ (1.0.0 â†’ 1.0.1)
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ìƒˆ ë²„ì „: $NEW_VERSION"

          - name: app.json ì—…ë°ì´íŠ¸
          run: |
            sed -i 's/"version": "[^"]*"/"version": "'${{ steps.version.outputs.new_version }}'"/' app.json
            echo "app.json ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${{ steps.version.outputs.new_version }}"

      - name: CodeRabbit Summary ì—…ë°ì´íŠ¸ ê°ì§€ (ìŠ¤ë§ˆíŠ¸ í´ë§)
        id: detect_summary
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          VERSION="${{ steps.version.outputs.new_version }}"
          TODAY=$(date '+%Y-%m-%d')
          MAX_ATTEMPTS=120
          ATTEMPT=0
          echo "ğŸ” PR #$PR_NUMBERì—ì„œ CodeRabbit Summary ì—…ë°ì´íŠ¸ ê°ì§€ ì‹œì‘..."
          echo "ìµœëŒ€ ëŒ€ê¸° ì‹œê°„: 10ë¶„ (5ì´ˆë§ˆë‹¤ ì²´í¬)"
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "[$ATTEMPT/$MAX_ATTEMPTS] CodeRabbit Summary í™•ì¸ ì¤‘... ($(date '+%H:%M:%S'))"
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3.html" \
                 "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}" \
                 > pr_content.html
            if grep -q "No description provided" pr_content.html; then
              echo "âŒ ì•„ì§ 'No description provided' ìƒíƒœì…ë‹ˆë‹¤"
            elif grep -q "Summary by CodeRabbit" pr_content.html; then
              echo "âœ… CodeRabbit Summary ë°œê²¬! íŒŒì‹±ì„ ì‹œì‘í•©ë‹ˆë‹¤"
              echo "SUMMARY_FOUND=true" >> $GITHUB_ENV
              break
            else
              echo "â³ CodeRabbit Summary ì•„ì§ ì—†ìŒ"
            fi
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              sleep 5
            fi
          done
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "âš ï¸ 10ë¶„ ëŒ€ê¸° í›„ì—ë„ CodeRabbit Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            echo "SUMMARY_FOUND=false" >> $GITHUB_ENV
          fi

      - name: ë™ì  Summary íŒŒì‹± ë° CHANGELOG.json ì—…ë°ì´íŠ¸
        if: env.SUMMARY_FOUND == 'true'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          VERSION="${{ steps.version.outputs.new_version }}"
          TODAY=$(date '+%Y-%m-%d')
          TIMESTAMP=$(date '+%Y-%m-%dT%H:%M:%SZ')
          echo "ğŸ“ CodeRabbit Summary ë™ì  íŒŒì‹± ì‹œì‘..."
          sed -n '/<h2[^>]*>Summary by CodeRabbit<\/h2>/,/<\/div>/p' pr_content.html > summary_section.html
          echo "ğŸ“„ ì¶”ì¶œëœ Summary ì„¹ì…˜ í¬ê¸°: $(wc -c < summary_section.html) bytes"
          if [ $(wc -c < summary_section.html) -lt 100 ]; then
            echo "âš ï¸ Summary ì„¹ì…˜ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤. ì „ì²´ PR ë‚´ìš©ì—ì„œ ë‹¤ì‹œ ì¶”ì¶œ ì‹œë„..."
            grep -A 50 "Summary by CodeRabbit" pr_content.html > summary_section.html
          fi
          cat summary_section.html | sed 's/<[^>]*>//g' | sed 's/&nbsp;/ /g; s/&amp;/\&/g; s/&lt;/</g; s/&gt;/>/g; s/&quot;/"/g' > raw_summary.txt
          echo "ğŸ” ë™ì  ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ ì¤‘..."
          echo "ğŸ“„ Summary ì„¹ì…˜ ë¯¸ë¦¬ë³´ê¸°:"
          head -10 summary_section.html

          # Pythonìœ¼ë¡œ ë™ì  íŒŒì‹±
          cat > parse_changelog.py << 'EOF'
          import re
          import json
          import html
          import sys
          import os
          from datetime import datetime

          def extract_items_from_section(html_content, section_title):
                """íŠ¹ì • ì„¹ì…˜ì˜ ì•„ì´í…œë“¤ì„ ì¶”ì¶œ"""
              print(f"ğŸ“‹ '{section_title}' ì„¹ì…˜ì—ì„œ ì•„ì´í…œ ì¶”ì¶œ ì¤‘...")
              
              # ë‹¤ì–‘í•œ íŒ¨í„´ìœ¼ë¡œ ì„¹ì…˜ ì°¾ê¸°
              patterns = [
                  f'<strong[^>]*>{re.escape(section_title)}[^<]*</strong>',
                  f'<li[^>]*><strong[^>]*>{re.escape(section_title)}[^<]*</strong>',
                  f'<p[^>]*><strong[^>]*>{re.escape(section_title)}[^<]*</strong></p>'
              ]
              section_match = None
              for pattern in patterns:
                  section_match = re.search(pattern, html_content, re.IGNORECASE)
                  if section_match:
                      print(f"âœ… íŒ¨í„´ ë§¤ì¹˜: {pattern[:50]}...")
                      break
              if not section_match:
                  print(f"âŒ íŒ¨í„´ ë§¤ì¹˜ ì‹¤íŒ¨: {pattern[:50]}...")
                  return []
              
              # ì„¹ì…˜ ì´í›„ì˜ ul íƒœê·¸ ì°¾ê¸°
              after_section = html_content[section_match.end():]
              ul_match = re.search(r'<ul[^>]*>(.*?)</ul>', after_section, re.DOTALL)
              
              if not ul_match:
                  print(f"âŒ '{section_title}' ì„¹ì…˜ ì´í›„ ul íƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")
                  return []
              ul_content = ul_match.group(1)
              li_items = re.findall(r'<li[^>]*>(.*?)</li>', ul_content, re.DOTALL)
              items = []
              for item in li_items:
                  clean_text = re.sub(r'<[^>]*>', '', item)
                  clean_text = html.unescape(clean_text).strip()
                  if clean_text:
                      items.append(clean_text)
                      print(f"  ğŸ“ ì•„ì´í…œ: {clean_text[:50]}...")
              
              print(f"âœ… '{section_title}' ì„¹ì…˜ì—ì„œ {len(items)}ê°œ ì•„ì´í…œ ì¶”ì¶œ ì™„ë£Œ")
              return items

          def detect_categories(html_content):
              detected_categories = {}
              strong_texts = re.findall(r'<strong[^>]*>([^<]+)</strong>', html_content, re.IGNORECASE)
              for strong_text in strong_texts:
                  clean_text = strong_text.strip()
                  items = extract_items_from_section(html_content, clean_text)
                  if items:
                      safe_key = re.sub(r'[^a-zA-Z0-9ê°€-í£]', '_', clean_text.lower()).strip('_')
                      if not safe_key:
                          safe_key = f"category_{len(detected_categories)}"
                      detected_categories[safe_key] = {
                          'title': clean_text,
                          'items': items
                      }
              return detected_categories

          def main():
              version = os.environ.get('VERSION')
              today = os.environ.get('TODAY')
              pr_number = int(os.environ.get('PR_NUMBER'))
              timestamp = os.environ.get('TIMESTAMP')
              try:
                  with open('summary_section.html', 'r', encoding='utf-8') as f:
                      html_content = f.read()
                  categories = detect_categories(html_content)
                  with open('raw_summary.txt', 'r', encoding='utf-8') as f:
                      raw_summary = f.read().strip()
                  new_release = {
                      "version": version,
                      "date": today,
                      "pr_number": pr_number,
                      "raw_summary": raw_summary,
                      "parsed_changes": {}
                  }
                  for key, value in categories.items():
                      new_release["parsed_changes"][key] = value["items"]
                  try:
                      with open('Wit/CHANGELOG.json', 'r', encoding='utf-8') as f:
                          changelog_data = json.load(f)
                  except (FileNotFoundError, json.JSONDecodeError):
                      changelog_data = {
                          "metadata": {
                              "lastUpdated": timestamp,
                              "currentVersion": version,
                              "totalReleases": 0
                          },
                          "releases": []
                      }
                  changelog_data["metadata"]["lastUpdated"] = timestamp
                  changelog_data["metadata"]["currentVersion"] = version
                  changelog_data["metadata"]["totalReleases"] = len(changelog_data["releases"]) + 1
                  changelog_data["releases"].insert(0, new_release)
                  with open('Wit/CHANGELOG.json', 'w', encoding='utf-8') as f:
                      json.dump(changelog_data, f, indent=2, ensure_ascii=False)

                  print("âœ… CHANGELOG.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
                  print(f"ğŸ“Š ì´ {len(categories)}ê°œ ì¹´í…Œê³ ë¦¬, {sum(len(v['items']) for v in categories.values())}ê°œ ë³€ê²½ì‚¬í•­")
                  
              except Exception as e:
                  print(f"âŒ íŒŒì‹± ì˜¤ë¥˜: {e}")
                  sys.exit(1)
          if __name__ == "__main__":
              main()
          EOF
          export VERSION="$VERSION"
          export TODAY="$TODAY"
          export PR_NUMBER="$PR_NUMBER"
          export TIMESTAMP="$TIMESTAMP"
          python3 parse_changelog.py

      - name: CHANGELOG.md ì¬ìƒì„±
        if: env.SUMMARY_FOUND == 'true'
        run: |
          echo "ğŸ“„ CHANGELOG.jsonì—ì„œ CHANGELOG.md ì¬ìƒì„± ì¤‘..."
          python3 << 'PYTHON_SCRIPT'
          import json
          try:
              with open('CHANGELOG.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              with open('CHANGELOG.md', 'w', encoding='utf-8') as f:
                  f.write("# Changelog\n\n")
                  for release in data['releases']:
                      f.write(f"## [{release['version']}] - {release['date']}\n\n")
                      for category_key, items in release['parsed_changes'].items():
                          if items:
                              title = category_key.replace('_', ' ').title()
                              if isinstance(items, dict) and 'title' in items:
                                  title = items['title']
                                  actual_items = items['items']
                              else:
                                  actual_items = items
                              f.write(f"**{title}**\n")
                              for item in actual_items:
                                  f.write(f"- {item}\n")
                              f.write("\n")
                      f.write("---\n\n")
              print("âœ… CHANGELOG.md ì¬ìƒì„± ì™„ë£Œ!")
          except Exception as e:
              print(f"âŒ CHANGELOG.md ìƒì„± ì‹¤íŒ¨: {e}")
              exit(1)
          PYTHON_SCRIPT

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: env.SUMMARY_FOUND == 'true'
        run: |
          # ìµœì‹  ìƒíƒœë¡œ ë‹¤ì‹œ pull
          git pull origin develop

          # ë³€ê²½ì‚¬í•­ ì¶”ê°€
          git add app.json CHANGELOG.json CHANGELOG.md

          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "ğŸ“ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          else
            git commit -m "Malsami ë²„ì „ ê´€ë¦¬ : chore: ë²„ì „ ${{ steps.version.outputs.new_version }} (PR #${{ github.event.pull_request.number }})"
            git push origin develop
            echo "âœ… ë³€ê²½ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ë˜ì—ˆìŠµë‹ˆë‹¤"
          fi

      - name: ì—…ë°ì´íŠ¸ ì™„ë£Œ ì•Œë¦¼
        run: |
          if [ "${{ env.SUMMARY_FOUND }}" == "true" ]; then
            echo "âœ… CHANGELOG ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
            echo "ğŸ“¦ ìƒˆ ë²„ì „: ${{ steps.version.outputs.new_version }}"
            echo "ğŸ”— PR: #${{ github.event.pull_request.number }}"
            echo "ğŸ“„ app.json, CHANGELOG.json ë° CHANGELOG.mdê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤"
            echo "ğŸ¯ ë™ì  ì¹´í…Œê³ ë¦¬ íŒŒì‹±ìœ¼ë¡œ AI ìƒì„± ì½˜í…ì¸  ìœ ì—°í•˜ê²Œ ì²˜ë¦¬ë¨"
          else
            echo "âš ï¸ CodeRabbit Summaryë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤"
          fi

      - name: ì •ë¦¬
        run: |
          rm -f pr_content.html summary_section.html raw_summary.txt parse_changelog.py

      - name: ìë™ PR Merge ë° main ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸
        if: env.SUMMARY_FOUND == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ”„ PR #${{ github.event.pull_request.number }} ìë™ ë¨¸ì§€ ì‹œë„ ì¤‘..."

          # PR ìƒíƒœ í™•ì¸
          PR_STATE=$(gh pr view ${{ github.event.pull_request.number }} --json state,mergeable --jq '.state + "," + (.mergeable | tostring)')
          echo "PR ìƒíƒœ: $PR_STATE"

          # ë¨¸ì§€ ì‹œë„
          if gh pr merge ${{ github.event.pull_request.number }} --merge; then
            echo "âœ… PRì´ ì„±ê³µì ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ PR ë¨¸ì§€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ì„¸ìš”."
            exit 1
          fi

          echo "ğŸš€ main ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸ ì‹œì‘..."
          # í˜„ì¬ develop ë¸Œëœì¹˜ì˜ ìµœì‹  ìƒíƒœë¥¼ main ë¸Œëœì¹˜ë¡œ ê°•ì œ í‘¸ì‹œ
          # í˜„ì¬ ë¸Œëœì¹˜ê°€ developì´ë¯€ë¡œ ì§ì ‘ í‘¸ì‹œ ê°€ëŠ¥
          git push origin HEAD:main --force

          echo "âœ… main ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ! ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤."
